<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Undertale Special Thanks</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background-color: black;
            }
            canvas {
                display: block;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <div
            id="score"
            style="
                position: fixed;
                top: 20px;
                left: 20px;
                color: white;
                font-size: 18px;
            "
        ></div>
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const messages = ["ありがとう", "感謝", "お疲れ様", "単語1"];
            let touchedWords = []; // 触れた単語を管理する配列
            let textIndex = 0;
            let alreadyAlert = false; // すでに"finish"を表示したかどうかを管理するフラグ

            class Text {
                constructor(text, x, y, speed) {
                    this.text = text;
                    this.x = x;
                    this.y = y;
                    this.speed = speed;
                    this.color = "white";
                    this.angle = 0;
                    this.rotated = false;
                    this.targetReached = false;
                    this.directionSet = false;
                    this.touched = false; // 単語がハートに触れたかどうかを管理するフラグ
                }

                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    ctx.fillStyle = this.color;
                    ctx.font = "50px Arial";
                    ctx.fillText(
                        this.text,
                        -ctx.measureText(this.text).width / 2,
                        0,
                    );
                    ctx.restore();
                }

                update() {
                    if (!this.targetReached) {
                        this.x += this.speed;
                        if (
                            (this.speed > 0 && this.x >= canvas.width - 100) ||
                            (this.speed < 0 && this.x <= 100)
                        ) {
                            this.targetReached = true;
                            this.speed = 0;
                            setTimeout(() => {
                                this.rotated = true;
                            }, 1000); // 一時停止の時間（1秒）
                        }
                    } else if (this.rotated && !this.directionSet) {
                        this.angle += 0.1;
                        if (this.angle >= Math.PI * 2) {
                            this.angle = 0;
                            this.directionSet = true;
                            // ハートの方向を計算
                            const dx = heart.x - this.x;
                            const dy = heart.y - this.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            this.speedX = (dx / distance) * 10; // スピードを増加
                            this.speedY = (dy / distance) * 10; // スピードを増加
                            this.angle = Math.atan2(dy, dx);
                        }
                    } else if (this.directionSet) {
                        this.x += this.speedX;
                        this.y += this.speedY;
                    }
                }

                checkCollision(heart) {
                    const dx = this.x - heart.x;
                    const dy = this.y - heart.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 30 && !this.touched) {
                        // 単語がハートに触れておらず、かつ距離が近い場合
                        this.color = "yellow";
                        this.touched = true; // 触れた単語としてマーク
                        touchedWords.push(this.text); // 触れた単語を配列に追加
                    }
                }
            }

            class Heart {
                constructor() {
                    this.x = canvas.width / 2;
                    this.y = canvas.height - 50;
                    this.size = 30; // ハートの大きさを20に変更
                    this.speed = 4;
                    this.symbol = "❤";
                }

                draw() {
                    ctx.fillStyle = "red";
                    ctx.font = `${this.size}px Arial`; // フォントサイズをハートの大きさに応じて設定
                    ctx.fillText(this.symbol, this.x - 10, this.y + 10);
                }

                update() {
                    if (arrowLeft && this.x > 0) {
                        this.x -= this.speed;
                    } else if (arrowRight && this.x < canvas.width) {
                        this.x += this.speed;
                    }
                    if (arrowUp && this.y > 0) {
                        this.y -= this.speed;
                    } else if (arrowDown && this.y < canvas.height) {
                        this.y += this.speed;
                    }
                }
            }

            const heart = new Heart();
            const texts = [];

            let arrowLeft = false;
            let arrowRight = false;
            let arrowUp = false;
            let arrowDown = false;

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                heart.draw();
                heart.update();
                let allTextsFinished = true; // すべてのテキストが終了したかどうかを管理するフラグ

                texts.forEach((text) => {
                    text.draw();
                    text.update();
                    text.checkCollision(heart);
                    if (!text.targetReached) {
                        allTextsFinished = false; // まだテキストが終了していないものがあればフラグをfalseにする
                    }
                });

                if (allTextsFinished && texts.length > 0 && !alreadyAlert) {
                    alreadyAlert = true;
                    console.log("finish");

                    setTimeout(function () {
                        console.log("5s");
                        ctx.clearRect(0, 0, canvas.width, canvas.height); // 画面をクリア

                        const thankYouText = new Text(
                            "Thank you",
                            canvas.width / 2,
                            canvas.height / 2,
                            0,
                        );
                        texts.push(thankYouText);

                        setTimeout(function () {
                            texts.splice(texts.indexOf(thankYouText), 1);
                            scoresshow();
                        }, 5000); // 5秒後に"Thank you"を消去する
                    }, 5000);
                }

                requestAnimationFrame(animate);
            }

            function scoresshow() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // 画面をクリア

                // 触れた単語の一覧を表示するための文字列を生成
                const touchedWordsString =
                    touchedWords.length > 0 ? touchedWords.join(", ") : "なし";

                const scoreText = new Text(
                    "触れた単語数: " +
                        touchedWords.length +
                        " (" +
                        touchedWordsString +
                        ")",
                    canvas.width / 2,
                    canvas.height / 2,
                    0,
                );
                texts.push(scoreText);

                setTimeout(function () {
                    texts.splice(texts.indexOf(scoreText), 1);
                }, 5000); // 5秒後にスコア表示を消去する
            }

            function addText() {
                if (textIndex < messages.length) {
                    const msg = messages[textIndex];
                    const newText = new Text(
                        msg,
                        textIndex % 2 === 0 ? -100 : canvas.width + 100,
                        Math.random() * canvas.height,
                        textIndex % 2 === 0 ? 5 : -5, // スピードを増加
                    );
                    texts.push(newText);
                    textIndex++;
                    setTimeout(addText, 1000); // 1秒後に次のテキストを追加
                }
            }

            addText();
            animate();

            window.addEventListener("keydown", (e) => {
                if (e.key === "ArrowLeft") arrowLeft = true;
                if (e.key === "ArrowRight") arrowRight = true;
                if (e.key === "ArrowUp") arrowUp = true;
                if (e.key === "ArrowDown") arrowDown = true;
            });

            window.addEventListener("keyup", (e) => {
                if (e.key === "ArrowLeft") arrowLeft = false;
                if (e.key === "ArrowRight") arrowRight = false;
                if (e.key === "ArrowUp") arrowUp = false;
                if (e.key === "ArrowDown") arrowDown = false;
            });
        </script>
    </body>
</html>
